<!DOCTYPE HTML>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no, user-scalable=no,minimum-scale=1.0, maximum-scale=1.0" />
    <title>金币商城 - 兑换</title>

    <meta name="keywords" content="股指期货,期指,黄金,白银,沪深300,中证500,上证50">

    <link rel="stylesheet" href="/content/assets/css/page/mall/authentication.css?_=201610330">
    
    <script>
		document.getElementsByTagName('html')[0].style.fontSize = '100px'; 
	</script>
    
    <script src="/content/assets/js/biz/jquery-1.12.1.min.js"></script>

</head>

<body>

<!-- 头部 -->
<header class="head" id='head'>
	 <a href="javascript:window.history.back()" class="icon-youjiantou"></a>
    <h3>兑换</h3>
</header>
<!-- 内容 -->
<section class="main">
   
    <div class="top">请务必填写真实信息，以免影响您的兑换</div>
    
    <ul>
        <li>
            <p>姓名</p>
            <input id="name" type="text" placeholder="请输入姓名">
        </li>
        <li>
            <p>身份证</p>
            <input id="idcard" type="text" placeholder="请输入身份证号">
        </li>
        <li>
            <p>手机号</p>
            <input id="phone" type="text" placeholder="请输入手机号">
        </li>
        <li>
            <p>QQ</p>
            <input id="qq" type="text" placeholder="请输入QQ">
        </li>
    </ul>
    
    <input type="button" class="button" value="提交认证">
    
</section>

<footer class="foot">
    <p>温馨提示：</p>
    <p>1.兑换的话费默认充值到注册手机号中，如需更换请联系首页客服；</p>
    <p>2.兑换的京东E卡实为电子卡，卡号及卡密默认发送至您注册的手机号中，如需更换请联系首页客服；</p>
    <p>3.兑换实物的用户，客服会于1个工作日内与您联系，届时请提供您的邮寄地址，奖品会于3个工作日内寄出；</p>
</footer>
<script src="../content/assets/js/biz/nohead.js"></script>
<div id="alert1">
	<div class="input">
        <p></p>
        <div class="btn clear">
            <div class="btnL">确定</div>
    	</div>
    </div>
</div>

<div id="alert2">
	<div class="input">
        <p>您已在其他设备登录请确认</p>
        <div class="btn clear">
            <a class="btnL" href="/user/login.html">确定</a>
    	</div>
    </div>
</div>

<script>
    
    var $name = $('#name'),
    $phone = $('#phone'),
    $qq = $('#qq'),
    $button = $('.button'),
    $idcard = $('#idcard'),
    onoff = false;
    
    var reg = new RegExp("(^|&)id=([^&]*)(&|$)", "i");
    var r = window.location.search.substr(1).match(reg);
    var Id = unescape(r[2]);
    
    $button.on('click',submit);
    
    $name.on('keyup',function(){
        if(($name.val().length >= 2) && ($phone.val().length >= 11)){
            $button.addClass('show');
            onoff = true;
        }
        else{
            $button.removeClass('show');
            onoff = false;
        }
    });
    
    $phone.on('input',function(){
        if(($name.val().length >= 2) && ($phone.val().length >= 11)){
            $button.addClass('show');
            onoff = true;
        }
        else{
            $button.removeClass('show');
            onoff = false;
        }
    });
    
    $phone.blur(function(){
        if(($name.val().length >= 2) && ($phone.val().length >= 11)){
            $button.addClass('show');
            onoff = true;
        }
        else{
            $button.removeClass('show');
            onoff = false;
        }
    });
    $name.blur(function(){
        if(($name.val().length >= 2) && ($phone.val().length >= 11)){
            $button.addClass('show');
            onoff = true;
        }
        else{
            $button.removeClass('show');
            onoff = false;
        }
    });
    
    $.ajax({
        url: '/user/shopping/findUserInfo.do',
        data: {},
        dataType: 'json',
        type: 'post',
        success: function (data) {
            if(data.code == 200){
                $name.val(data.data.realName);
                $phone.val(data.data.userPhone);
                $idcard.val(data.data.idCard);
            }
            else if(data.code == 503){
                $('#alert2').show();
            }
            if( ($name.val() != '') && ($phone.val() != '') ){
                $button.addClass('show');
                onoff = true;
            }
            else{
                $button.removeClass('show');
                onoff = false;
            }
        }
    });
    
    function submit(){
        if(onoff){
            var d = {
                    goodsId : Id,
                    realName : $name.val(),
                    userPhone : $phone.val(),
                    idCard : $idcard.val()
                }
            if($qq.val()){
                d = $.extend(d,{qq:$qq.val()});
            }
            $.ajax({
                url: '/user/shopping/purchaseGoods.do',
                data: d,
                dataType: 'json',
                type: 'post',
                success: function (data) {
                    if(data.code == 200){
                        mask('恭喜您已兑换成功，兑换商品会于1-3个工作日内发出',function(){
                            window.location.href = '/mall/mall_exchange.html';
                        })
                    }
                    else{
                        mask('抱歉，您的兑换操作失败，如有疑问可联系首页的客服，或拨打400客服电话！感谢您的支持与理解~',function(){
                            window.location.href = '/mall/mall.html';
                        })
                    }
                }
            });
        }
    }
    
    
    function mask(str,fn){
        var $mask = $('#alert1');
        var $text = $mask.find('p');
        var $sure = $mask.find('.btnL');
        var $nosure = $mask.find('.btnR');
        $text.html(str)
        $mask.show();
        $sure.on('click',function(){
            fn();
            $mask.hide();
        });
        $nosure.on('click',function(){
            $mask.hide();
            window.location.href = '/mall/mall.html';
        });
        
    }
    
</script>

</body>
</html>