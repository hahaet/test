<!DOCTYPE HTML>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no, user-scalable=no,minimum-scale=1.0, maximum-scale=1.0" />
    <title>金币商城 - 兑换详情</title>

    <meta name="keywords" content="股指期货,期指,黄金,白银,沪深300,中证500,上证50">

    <link rel="stylesheet" href="/content/assets/css/page/mall/details.css?_=201610330">
    
    <script>
		document.getElementsByTagName('html')[0].style.fontSize = '100px'; 
	</script>
    
    <script src="/content/assets/js/biz/jquery-1.12.1.min.js"></script>

</head>

<body>

<!-- 头部 -->
<header class="head" id="head">
	 <a href="javascript:window.history.back()" class="icon-youjiantou"></a>
    <h3>兑换详情</h3>
</header>
<!-- 内容 -->
<section class="main">
   
    <div class="top">
        <img id="img1">
    </div>
    
    <div class="middle">
        <div class="Mcontent">
            <div class="firstD">
                <span class="btn1">兑换</span>
                <span id="Pname"></span>
            </div>

            <div class="twoD">
                <span>所需金币</span>
                <span class="icon-icon_coin"></span>
                <span id="Pmoney"></span>
            </div>
        </div>
    </div>
    
    <div class="second">
        <div class="title">
            <div class="red"></div>
            <p>兑换说明</p>
        </div>
        
        <div class="Scontent">
            
            <p class="shuoM"></p>
            <p class="p1"></p>
            
        </div>
    </div>
    
    <div class="bottom">
       
        <div class="title">
            <div class="red"></div>
            <p>商品详情</p>
        </div>
        
        <div class="bottomC">
        
        
        </div>
    </div>
    
</section>

<div class="buyNow">立即兑换</div> 

<div id="alert1">
	<div class="input">
        <p></p>
        <div class="btn clear">
            <div class="btnL">确定</div>
            <div class="btnR">取消</div>
    	</div>
    </div>
</div>

<div id="alert2">
	<div class="input">
        <p>您已在其他设备登录请确认</p>
        <div class="btn clear">
            <a class="btnL" href="/user/login.html">确定</a>
    	</div>
    </div>
</div>
<script src="../content/assets/js/biz/nohead.js"></script>
<script>
    
    var $Pname = $('#Pname'),
    $Pmoney = $('#Pmoney'),
    $shuoM = $('.shuoM'),
    $p1 = $('.p1'),
    $bottomC = $('.bottomC'),
    $buyNow = $('.buyNow'),
    $img1 = $('#img1'),
    num = 0;
    
    var reg = new RegExp("(^|&)id=([^&]*)(&|$)", "i");
    var r = window.location.search.substr(1).match(reg);
    var Id = unescape(r[2]);
    
    
    $.ajax({
        url: '/user/shopping/findGoods.do',
        data: {
            id :Id
        },
        dataType: 'json',
        type: 'post',
        success: function (data) {
            if(data.code == 200){
                $img1.attr('src',data.data.detailImage);
                $Pname.html(data.data.name);        //商品名称
                $Pmoney.html(data.data.price);       //所需金币
                $shuoM.html(data.data.direction);      //兑换说明
                $p1.html(data.data.reminder);                 //温馨提示
                $bottomC.html(data.data.content)    //商品详情
                
                if(data.data.status != 0){
                    $buyNow.css('background','#abaaaa');
                    $buyNow.html('该商品已下架');
                }
                else{
                    num = data.data.price;
                    
                    $.ajax({
                        url: '/user/shopping/findIsExchangeAble.do',
                        data: { },
                        dataType: 'json',
                        type: 'post',
                        success: function (d) {
                            if(d.code == 200){
                                if(d.data){
                                    buy()
                                }
                                else{
                                    $buyNow.css('background','#abaaaa');
                                    $buyNow.html('您还未进行任何交易');
                                }
                            }
                        }
                    });
                    
                }
                      
            }
            else{
                $('#alert2').show();
            }
        }
    });
    
    function buy(){
        $.ajax({
            url: '/user/finance/findMain.do',
            data: {},
            dataType: 'json',
            type: 'post',
            success: function (d) {
                if(d.code == 200){
                    if((d.data.scoreUsable - num) <= 0){
                        $buyNow.css('background','#abaaaa');
                        $buyNow.html('您的金币不足');
                    }
                    else{
                        $buyNow.on('click',function(){
                            window.location.href = '/mall/mall_authentication.html?id='+Id;
                        });
                    };
                }
            }
        });
    }
    
    function mask(str,fn){
        var $mask = $('#alert1');
        var $text = $mask.find('p');
        var $sure = $mask.find('.btnL');
        var $nosure = $mask.find('.btnR');
        
        $text.html(str)
        
        $mask.show();
        
        $sure.on('click',function(){
            fn();
            $mask.hide();
        });
        
        $nosure.on('click',function(){
            $mask.hide();
            window.location.href = '/index.html'
        });
        
    }
    
</script>
</body>
</html>